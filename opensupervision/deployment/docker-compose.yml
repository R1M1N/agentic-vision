# OpenSupervision - Complete Platform Docker Compose
# Deploy the entire sovereign computer vision stack

version: '3.8'

services:
  # =============================================================================
  # Storage Layer
  # =============================================================================
  
  minio:
    image: minio/minio:latest
    container_name: opensupervision-minio
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"  # S3 API
      - "9001:9001"  # MinIO Console
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin123
      MINIO_CONSOLE_ADDRESS: ":9001"
    volumes:
      - minio_data:/data
    networks:
      - opensupervision-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    restart: unless-stopped
  
  # =============================================================================
  # Database Layer
  # =============================================================================
  
  mongodb:
    image: mongo:6.0
    container_name: opensupervision-mongodb
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin123
      MONGO_INITDB_DATABASE: fiftyone
    volumes:
      - mongodb_data:/data/db
    networks:
      - opensupervision-net
    restart: unless-stopped
  
  postgres:
    image: postgres:15
    container_name: opensupervision-postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: mlflow
      POSTGRES_USER: mlflow
      POSTGRES_PASSWORD: mlflow123
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - opensupervision-net
    restart: unless-stopped
  
  redis:
    image: redis:7-alpine
    container_name: opensupervision-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - opensupervision-net
    restart: unless-stopped
  
  # =============================================================================
  # Annotation Platform
  # =============================================================================
  
  cvat-db:
    image: postgres:15-alpine
    container_name: opensupervision-cvat-db
    environment:
      POSTGRES_USER: cvat
      POSTGRES_PASSWORD: cvat
      POSTGRES_DB: cvat
    volumes:
      - cvat_db_data:/var/lib/postgresql/data
    networks:
      - opensupervision-net
    restart: unless-stopped
  
  cvat-redis:
    image: redis:6-alpine
    container_name: opensupervision-cvat-redis
    networks:
      - opensupervision-net
    restart: unless-stopmed
  
  cvat-backend:
    image: cvat/server:latest
    container_name: opensupervision-cvat-backend
    depends_on:
      - cvat-db
      - cvat-redis
      - minio
    environment:
      CVAT_DB_HOST: cvat-db
      CVAT_DB_USER: cvat
      CVAT_DB_PASSWORD: cvat
      CVAT_DB_NAME: cvat
      CVAT_REDIS_HOST: cvat-redis
      CVAT_REDIS_HOST: cvat-redis
      CVAT_ANALYTICS: 'false'
    volumes:
      - cvat_data:/home/django/data
      - cvat_keys:/home/django/keys
      - cvat_logs:/home/django/logs
    networks:
      - opensupervision-net
    restart: unless-stopped
  
  cvat-worker:
    image: cvat/server:latest
    container_name: opensupervision-cvat-worker
    depends_on:
      - cvat-db
      - cvat-redis
      - cvat-backend
    environment:
      CVAT_DB_HOST: cvat-db
      CVAT_DB_USER: cvat
      CVAT_DB_PASSWORD: cvat
      CVAT_DB_NAME: cvat
      CVAT_REDIS_HOST: cvat-redis
    volumes:
      - cvat_data:/home/django/data
    networks:
      - opensupervision-net
    restart: unless-stopped
  
  cvat-ui:
    image: cvat/ui:latest
    container_name: opensupervision-cvat-ui
    depends_on:
      - cvat-backend
    environment:
      CVAT_WS_HOST: cvat-backend
      CVAT_WS_PROTO: ws
      CVAT_HOST: localhost
      CVAT_PORT: 8080
    networks:
      - opensupervision-net
    restart: unless-stopped
  
  # =============================================================================
  # OpenSupervision Core Services
  # =============================================================================
  
  mlflow:
    image: python:3.9-slim
    container_name: opensupervision-mlflow
    command: >
      bash -c "
        pip install mlflow psycopg2-binary &&
        mlflow server 
        --backend-store-uri postgresql://mlflow:mlflow123@postgres:5432/mlflow 
        --default-artifact-root s3://mlflow-artifacts/ 
        --host 0.0.0.0 
        --port 5000
      "
    ports:
      - "5000:5000"
    environment:
      MLFLOW_BACKEND_STORE_URI: postgresql://mlflow:mlflow123@postgres:5432/mlflow
      AWS_ACCESS_KEY_ID: minioadmin
      AWS_SECRET_ACCESS_KEY: minioadmin123
      MLFLOW_S3_ENDPOINT_URL: http://minio:9000
    depends_on:
      - postgres
      - minio
    networks:
      - opensupervision-net
    restart: unless-stopped
  
  fiftyone:
    image: voxel51/fiftyone:latest
    container_name: opensupervision-fiftyone
    ports:
      - "5151:5151"
    environment:
      FIFTYONE_DATABASE_URI: mongodb://admin:admin123@mongodb:27017/fiftyone?authSource=admin
      FIFTYONE_BRAIN_UPDATE: "true"
    volumes:
      - fiftyone_data:/fiftyone/db
    depends_on:
      - mongodb
    networks:
      - opensupervision-net
    restart: unless-stopped
  
  # =============================================================================
  # Inference Server
  # =============================================================================
  
  inference:
    build:
      context: ..
      dockerfile: deployment/Dockerfile
    container_name: opensupervision-inference
    ports:
      - "8000:8000"
    environment:
      STORAGE_TYPE: minio
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin123
      MINIO_SECURE: "false"
      MONGODB_URI: mongodb://admin:admin123@mongodb:27017/fiftyone?authSource=admin
      MLFLOW_TRACKING_URI: http://mlflow:5000
      INFERENCE_PORT: 8000
      INFERENCE_BATCH_SIZE: 8
      CUDA_VISIBLE_DEVICES: "0"
    volumes:
      - model_cache:/models
      - inference_logs:/app/logs
    depends_on:
      - minio
      - mongodb
      - mlflow
    networks:
      - opensupervision-net
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    restart: unless-stopped
  
  # =============================================================================
  # Training Service
  # =============================================================================
  
  training:
    build:
      context: ..
      dockerfile: deployment/Dockerfile
    container_name: opensupervision-training
    environment:
      STORAGE_TYPE: minio
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin123
      MINIO_SECURE: "false"
      MONGODB_URI: mongodb://admin:admin123@mongodb:27017/fiftyone?authSource=admin
      MLFLOW_TRACKING_URI: http://mlflow:5000
      CUDA_VISIBLE_DEVICES: "0"
    volumes:
      - dataset_cache:/data
      - model_cache:/models
      - training_logs:/app/logs
    depends_on:
      - minio
      - mongodb
      - mlflow
    networks:
      - opensupervision-net
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    restart: unless-stopped
    # This service is for GPU training jobs
    deploy:
      replicas: 0  # Disabled by default, start manually for training jobs
  
  # =============================================================================
  # Web Interface
  # =============================================================================
  
  streamlit-ui:
    build:
      context: ..
      dockerfile: deployment/Dockerfile.ui
    container_name: opensupervision-streamlit
    ports:
      - "8501:8501"
    environment:
      STREAMLIT_SERVER_HEADLESS: "true"
      STREAMLIT_SERVER_PORT: 8501
      STREAMLIT_SERVER_ADDRESS: 0.0.0.0
      STREAMLIT_BROWSER_GATHER_USAGE_STATS: "false"
      STORAGE_TYPE: minio
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin123
      MINIO_SECURE: "false"
      MONGODB_URI: mongodb://admin:admin123@mongodb:27017/fiftyone?authSource=admin
      MLFLOW_TRACKING_URI: http://mlflow:5000
    volumes:
      - streamlit_data:/app/data
    depends_on:
      - minio
      - mongodb
      - mlflow
    networks:
      - opensupervision-net
    restart: unless-stopped
  
  # =============================================================================
  # Nginx Reverse Proxy
  # =============================================================================
  
  nginx:
    image: nginx:alpine
    container_name: opensupervision-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - nginx_logs:/var/log/nginx
    depends_on:
      - inference
      - streamlit-ui
      - cvat-ui
      - fiftyone
    networks:
      - opensupervision-net
    restart: unless-stopped
  
  # =============================================================================
  # Monitoring
  # =============================================================================
  
  prometheus:
    image: prom/prometheus:latest
    container_name: opensupervision-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    networks:
      - opensupervision-net
    restart: unless-stopped
  
  grafana:
    image: grafana/grafana:latest
    container_name: opensupervision-grafana
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin123
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./grafana/datasources:/etc/grafana/provisioning/datasources
    depends_on:
      - prometheus
    networks:
      - opensupervision-net
    restart: unless-stopped

# =============================================================================
# Networks
# =============================================================================

networks:
  opensupervision-net:
    driver: bridge

# =============================================================================
# Volumes
# =============================================================================

volumes:
  # Storage
  minio_data:
    driver: local
  mongodb_data:
    driver: local
  postgres_data:
    driver: local
  redis_data:
    driver: local
  
  # CVAT
  cvat_db_data:
    driver: local
  cvat_data:
    driver: local
  cvat_keys:
    driver: local
  cvat_logs:
    driver: local
  
  # OpenSupervision
  fiftyone_data:
    driver: local
  dataset_cache:
    driver: local
  model_cache:
    driver: local
  training_logs:
    driver: local
  inference_logs:
    driver: local
  streamlit_data:
    driver: local
  
  # Monitoring
  prometheus_data:
    driver: local
  grafana_data:
    driver: local
  nginx_logs:
    driver: local